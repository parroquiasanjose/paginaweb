<script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyClMS_Z91iHXCNcX96pADWZMT5OSo0K9Ao",
            authDomain: "paginawebparroquia-ced15.firebaseapp.com",
            projectId: "paginawebparroquia-ced15",
            storageBucket: "paginawebparroquia-ced15.appspot.com",
            messagingSenderId: "985514123567",
            appId: "1:985514123567:web:0579cd11eeecd9a81881da"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        // --- Referencias a los elementos del DOM ---
        const loginOverlay = document.getElementById('login-overlay');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        const mainContent = document.getElementById('main-content');
        const moduleViewer = document.getElementById('module-viewer');
        const moduleFrame = document.getElementById('module-frame');
        const dateTimeDisplay = document.getElementById('datetime-display');

        // --- Manejador del estado de autenticación ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuario está logueado. Verificamos si estaba viendo un módulo.
                const lastModuleUrl = sessionStorage.getItem('currentModuleUrl');
                if (lastModuleUrl) {
                    // Si hay una URL guardada, la mostramos en lugar del menú principal.
                    showModule(lastModuleUrl);
                } else {
                    // Si no, mostramos el menú principal.
                    loginOverlay.style.display = 'none';
                    mainContent.style.display = 'block';
                    moduleViewer.style.display = 'none';
                }
            } else {
                // Usuario no está logueado
                loginOverlay.style.display = 'flex';
                mainContent.style.display = 'none';
                moduleViewer.style.display = 'none';
                sessionStorage.removeItem('currentModuleUrl'); // Limpiamos por si acaso
            }
        });

        /**
         * Inicia sesión con las credenciales predefinidas.
         */
        window.login = async function() {
            const email = "adanrdmato@gmail.com";
            const password = "sanjose2025";
            
            loginButton.disabled = true;
            loginButton.textContent = "Ingresando...";
            loginError.textContent = "";

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged se encargará de mostrar/ocultar los elementos
            } catch (error) {
                console.error("Error de inicio de sesión:", error);
                loginError.textContent = "Error al ingresar. Verifique la conexión.";
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = "Ingresar";
            }
        }
        
        /**
         * Cierra la sesión del usuario.
         */
        window.logout = async function() {
            // Limpiamos la URL del módulo guardada al cerrar sesión.
            sessionStorage.removeItem('currentModuleUrl');
            try {
                await signOut(auth);
                // onAuthStateChanged se encargará de mostrar/ocultar los elementos
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                alert("No se pudo cerrar la sesión. Inténtelo de nuevo.");
            }
        }

        /**
         * Muestra el visor del módulo y guarda la URL en sessionStorage.
         * @param {string} url - La URL del módulo a cargar en el iframe.
         */
        window.showModule = function(url) {
            // Guardamos la URL del módulo actual en la sesión del navegador.
            sessionStorage.setItem('currentModuleUrl', url);
            
            mainContent.style.display = 'none';
            // Se añade un timestamp a la URL para evitar la caché del navegador
            moduleFrame.src = url + '?t=' + new Date().getTime();
            moduleViewer.style.display = 'flex';
        }

        /**
         * Oculta el visor del módulo, limpia sessionStorage y muestra la página principal.
         */
        window.goHome = function() {
            // Eliminamos la URL guardada porque volvemos al inicio.
            sessionStorage.removeItem('currentModuleUrl');

            moduleViewer.style.display = 'none';
            moduleFrame.src = 'about:blank'; // Detiene la carga del iframe
            mainContent.style.display = 'block';
        }

        /**
         * Actualiza el subtítulo con la fecha y la hora actuales.
         */
        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            const dateString = now.toLocaleDateString('es-ES', options);
            const timeString = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: true });
            
            const formattedDate = dateString.charAt(0).toUpperCase() + dateString.slice(1);
            dateTimeDisplay.textContent = `${formattedDate} | ${timeString}`;
        }

        // --- Inicialización ---
        updateDateTime();
        setInterval(updateDateTime, 60000);
    </script>
